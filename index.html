<!DOCTYPE html>
<html>
<head>
  <title>Invite Tree</title>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script>
    google.charts.load('current', {packages:["orgchart"]});
    google.charts.setOnLoadCallback(drawChart);

    // Your published CSV link here
    const sheetUrl = 'YOUR_CSV_LINK_HERE';

    async function drawChart() {
      const response = await fetch(sheetUrl);
      const text = await response.text();
      const rows = text.trim().split('\n').map(r => r.split(',').slice(0,2));

      // Build tree structure
      const tree = {};
      const allUsers = new Set();

      rows.forEach(([inviter, invitee]) => {
        allUsers.add(inviter);
        allUsers.add(invitee);

        if (!tree[inviter]) tree[inviter] = [];
        tree[inviter].push(invitee);

        if (!tree[invitee]) tree[invitee] = [];
      });

      // Recursive total under each user
      const totals = {};
      function countUnder(person) {
        if (totals[person] !== undefined) return totals[person];
        let total = 0;
        tree[person].forEach(child => {
          total += 1 + countUnder(child);
        });
        totals[person] = total;
        return total;
      }

      Object.keys(tree).forEach(person => countUnder(person));

      // Prepare Google OrgChart data
      const data = new google.visualization.DataTable();
      data.addColumn('string','Name');
      data.addColumn('string','Manager');
      data.addColumn('string','Tooltip');

      rows.forEach(([inviter, invitee]) => {
        data.addRow([`${invitee} (${totals[invitee]} ðŸ‘¤)`, inviter, `${inviter} invited ${invitee}`]);
      });

      // Find root nodes (people who were never invited)
      const allInvitees = new Set(rows.map(r=>r[1]));
      const roots = [...new Set(rows.map(r=>r[0]))].filter(p=>!allInvitees.has(p));
      roots.forEach(root => data.addRow([`${root} (${totals[root]} ðŸ‘¤)`, '', 'root']));

      const chart = new google.visualization.OrgChart(document.getElementById('chart_div'));
      chart.draw(data,{allowHtml:true});

      // Show total unique users
      document.getElementById('total_users').innerText = `Total unique users: ${allUsers.size} ðŸ‘¤`;
    }

    // Auto-refresh every 30s
    setInterval(drawChart,30000);
  </script>
</head>
<body style="font-family:sans-serif;text-align:center;">
  <h2>Invite Tree ðŸŒ³</h2>
  <div id="total_users" style="margin-bottom:10px;font-weight:bold;"></div>
  <div id="chart_div" style="width:100%;height:800px;"></div>
</body>
</html>
