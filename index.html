<!DOCTYPE html>
<html>
  <head>
    <title>Invite Tree</title>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script>
      google.charts.load('current', { packages: ["orgchart"] });
      google.charts.setOnLoadCallback(drawChart);

      const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTufzem3vQrgBLdQZjqOwqybt6OrT8NLt_I4ec5BMx2I_RzXHN0UiSb6LSbrgHSQ3CsTuWZyzW8D2U1/pub?output=csv';


      async function drawChart() {
        const response = await fetch(sheetUrl);
        const text = await response.text();
        const rows = text.trim().split('\n').map(r => r.split(',').slice(0,2));

        const tree = {};
        const totals = {};

        // Build tree structure
        rows.forEach(([inviter, invitee]) => {
          if (!tree[inviter]) tree[inviter] = [];
          tree[inviter].push(invitee);
          if (!tree[invitee]) tree[invitee] = [];
        });

        // Recursive total calculation
        function countUnder(person) {
          if (totals[person] !== undefined) return totals[person];
          let total = 0;
          tree[person].forEach(child => {
            total += 1 + countUnder(child);
          });
          totals[person] = total;
          return total;
        }

        Object.keys(tree).forEach(person => countUnder(person));

        // Prepare data for Google OrgChart
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Name');
        data.addColumn('string', 'Manager');
        data.addColumn('string', 'Tooltip');

        rows.forEach(([inviter, invitee]) => {
          data.addRow([`${invitee} (${totals[invitee]})`, inviter, `${inviter} invited ${invitee}`]);
        });

        // Add root nodes
        const allInvitees = new Set(rows.map(r => r[1]));
        const roots = [...new Set(rows.map(r => r[0]))].filter(p => !allInvitees.has(p));
        roots.forEach(root => data.addRow([`${root} (${totals[root]})`, '', 'root']));

        const chart = new google.visualization.OrgChart(document.getElementById('chart_div'));
        chart.draw(data, { allowHtml: true });
      }

      setInterval(drawChart, 30000); // auto-refresh every 30s
    </script>
  </head>

  <body style="font-family:sans-serif; text-align:center;">
    <h2>Invite Tree ðŸŒ³</h2>
    <div id="chart_div" style="width:100%; height:800px;"></div>
  </body>
</html>
