<!DOCTYPE html>
<html>
<head>
  <title>Invite Tree</title>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script>
    google.charts.load('current', {packages:["orgchart"]});
    google.charts.setOnLoadCallback(drawChart);

    const sheetUrl = 'YOUR_CSV_LINK_HERE';

    async function drawChart() {
      const response = await fetch(sheetUrl);
      const text = await response.text();
      const rows = text.trim().split('\n').map(r => r.split(',').slice(0,2));

      // Build tree mapping: parent -> children
      const tree = {};
      const allUsers = new Set();

      rows.forEach(([inviter, invitee]) => {
        allUsers.add(inviter);
        allUsers.add(invitee);
        if (!tree[inviter]) tree[inviter] = [];
        tree[inviter].push(invitee);
        if (!tree[invitee]) tree[invitee] = []; // ensure every node exists
      });

      // Find the root (user who was never invited)
      const invitees = new Set(rows.map(r => r[1]));
      const roots = [...allUsers].filter(u => !invitees.has(u));
      const root = roots.length ? roots[0] : [...allUsers][0];

      // Recursive function to calculate totals
      const totals = {};
      function countUnder(person) {
        if (totals[person] !== undefined) return totals[person];
        let total = 0;
        tree[person].forEach(child => {
          total += 1 + countUnder(child);
        });
        totals[person] = total;
        return total;
      }
      countUnder(root);

      // Prepare OrgChart data
      const data = new google.visualization.DataTable();
      data.addColumn('string','Name');
      data.addColumn('string','Manager');
      data.addColumn('string','Tooltip');

      function addToChart(person, parent) {
        data.addRow([`${person} (${totals[person]} ðŸ‘¤)`, parent, parent ? `${parent} invited ${person}` : 'root']);
        tree[person].forEach(child => addToChart(child, person));
      }

      addToChart(root, '');

      const chart = new google.visualization.OrgChart(document.getElementById('chart_div'));
      chart.draw(data,{allowHtml:true});

      // Total unique users
      document.getElementById('total_users').innerText = `Total unique users: ${allUsers.size} ðŸ‘¤`;
    }

    setInterval(drawChart,30000);
  </script>
</head>
<body style="font-family:sans-serif;text-align:center;">
  <h2>Invite Tree ðŸŒ³</h2>
  <div id="total_users" style="margin-bottom:10px;font-weight:bold;"></div>
  <div id="chart_div" style="width:100%;height:800px;"></div>
</body>
</html>
